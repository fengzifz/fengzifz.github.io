<!DOCTYPE>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-COMPATIBLE" content="chrome=1" />
	<meta name="description" content="Web前端，JavaScript，PHP，node，express，mongo，angular">
	<link rel="stylesheet" type="text/css" media="screen" href="../../stylesheets/stylesheet.css">
	<title>Damon's Blog</title>
</head>

<body>
<!-- Header Start -->
<div id="header_wrap" class="outer">
	<header class="inner">
		<a id="forkme_banner" href="https://github.com/fengzifz">View on GitHub</a>
		<h1 id="project_title"><a href="http://fengzifz.github.io" class="project_title_link">Damon's Blog</a></h1>
		<h2 id="project_tagline"></h2>
	</header>
</div>
<!-- Header End -->

<div id="main_content_wrap" class="outer">
	<section id="main_content" class="inner">
		<h2>在 AWS 上部署 MEAN 开发环境</h2>

		<h3>前言</h3>
		<ul>
			<li>该文档不会说如何在 AWS 上面创建 EC2 实例，如有需要，请自行参考 AWS 的文档</li>
			<li>该文档所说的内容，是针对 <b>Amazon Linux 64bit</b></li>
		</ul>

		<hr />


		<h3>安装 MongoDB</h3>

		<h4>为 MongoDB 创建 Amazon EBS volumes</h4>
		<p>EBS 用来永久保存数据，我们创建一个 EBS 后，可以随便挂在到任意的 Instance 上。</p>
		<ul>
			<li>登录 <a href="http://aws.amazon.com" target="_blank">AWS</a>，进入 EC2 管理界面</li>
			<li>
				点击 ELASTIC BLOCK STORE > Volumes > Create Volume 创建（注意：Amazon 会按照你所选择的 EBS 容量进行收费，
				建议一开始不要选择太多，以后可以按需扩容。
				<a href="http://aws.amazon.com/cn/ebs/pricing/" target="_blank">EBS 收费）</a>
			</li>
			<li>右键刚刚创建的 volume，点击 "Attach Volume"，把它挂载到你的 Instance 上</li>
		</ul>

		<h4>用 SSH 登录到 AWS EC2 Instance</h4>
		<pre><code>ssh -i aws_damon_node_singapore.pem ubuntu@ip</code></pre>

		<h4>在EBS volume 上创建文件系统</h4>
		<p>在上一个步骤中，创建了 EBS 并挂载到 Instance 后，你的这个 Instance 会创建一个/dev/sdf，然后我们在 terminal 里面执行：</p>
		<pre><code>sudo mkfs -t ext4 /dev/sdf</code></pre>
		<h5>挂载驱动器</h5>
		<pre><code>sudo mkdir -p /data/db
		sudo chown `id -u` /data/db</code></pre>

		<h5>启动时列出 volume</h5>
		<pre><code>sudo echo `/dev/sdf /data/db auto noatime,noexec,nodiratime 0 0` >> /etc/fstab</code></pre>
		<p>注意： 如果在这里遇到权限问题，可以切换到 root 用户在执行</p>
		<pre><code>sudo -s # root user</code></pre>

		<h5>挂载 volume</h5>
		<pre><code>sudo mount -a /dev/sdf /data/db</code></pre>

		<h5>下载 MongoDB</h5>
<pre><code>curl http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-2.0.2.tgz > m.tgz
tar xzf m.tgz</code></pre>

		<h5>使用 package manager 安装</h5>
<pre><code>sudo vi /etc/yum.repos.d/10gen.repo
# Then edit the file to contain:
name=10gen Repository
baseurl=http://download-distro.mongodb.org/repo/redhat/os/x86_64
gpgcheck=0</code></pre>

		<h5>使用 yum 安装</h5>
		<pre><code>sudo yum install mongo-10gen</code></pre>

		<h5>配置 MongoDB</h5>
<pre><code>sudo vi /etc/mongodb.conf
# Edit the file to contain:
oplogSize=8000
journal=true
dbpath=/data/db
logpath=/data/db/logs</code></pre>

		<h5>启动 MongoDB</h5>
		<pre><code>./mongodb-xxxxxx/bin/mongod</code></pre>

		<h5>自动启动 MongoDB</h5>
		<p>首先需要知道:</p>

		<ul>
			<li>mongod 命令路径：<code>/usr/bin/mongod</code></li>
			<li>MongoDB 目录：<code>/data/db</code></li>
			<li>Mongodb logs 文件：<code>/data/db/logs/work.log</code></li>
		</ul>

		<p>然后编辑 <code>/etc/rc.local</code>，在里面加入：</p>
		<pre><code>/usr/bin/mongod -dbpath=/data/db --fork --port 27017 --logpath=/data/db/logs/work.log --logappend --auth</code></pre>

		<p>然后把 <code>/data/db/mongod.lock</code> 删除。</p>
		<pre><code>sudo rm /data/db/mongod.lock</code></pre>

		<p>启动服务：</p>
		<pre><code>/usr/bin/mongod -dbpath=/data/db --fork --port 27017 --logpath=/data/db/logs/work.log --logappend --auth</code></pre>

		<p>如果出现以下错误：</p>
		<pre><code>ERROR: child process failed, exited with error number 1</code></pre>

		<p>那么可以把 <code>/etc/mongod.conf</code> 设置 <code>nojournal=true</code>，然后重新启动服务</p>

		<h5>参考资料：</h5>
		<ul>
			<li><a href="http://www.tuicool.com/articles/yeIzMf" target="_blank">Mongodb wont start ERROR: child process failed, exited with error numbe...</a></li>
			<li><a href="http://www.linuxidc.com/Linux/2011-07/39149.htm" target="_blank">Linux下设置MongoDB开机自启动</a></li>
		</ul>

		<hr />


		<h3>安装 NodeJs</h3>
		<p>网上绝大部分教程都是使用 <code>apt-get</code> 来安装 node，但 Amazon Linux 64bit 里面是没有 apt 组件的，因此，我们使用源码直接编译安装。</p>

		<h4>安装 gcc-c++</h4>
		<pre><code>yum install gcc-c++</code></pre>

		<h4>下载 NodeJs</h4>
		<pre><code>sudo wget http://nodejs.org/dist/v0.10.32/node-v0.10.32.tar.gz</code></pre>

		<h4>解压文件，并检查配置</h4>
<pre><code>cd ~/node-v0.10.32.tar.gz
tar xvf node-v0.10.32.tar.gz
cd node-v0.10.32
# 如果不先安装 gcc-c++，都这里会报错的
./configure</code></pre>

		<h4>安装 NodeJs</h4>
		<pre><code>make install</code></pre>

		<h4>检查安装是否成功</h4>
		<pre><code>node --version</code></pre>

		<p>如果能够成功返回 node 的版本号，说明已经安装成功</p>

		<hr />

		<h3>安装 ExpressJS 和 AngularJS</h3>
<pre><code>npm install express
npm install angular</code></pre>

		<hr />

		<h3>使用 forever 启动 NodeJS</h3>
		<p>forever 一个用来持续（或者说永远）运行一个给定脚本的简单的命令行工具。简单来说，就是可以可以启动、停止和重启我们的 app 应用的工具。</p>
<pre><code># 记得加-g，forever要求安装到全局环境下
sudo npm install forever -g</code></pre>

		<p>详细使用方式请 Google 之。</p>

		<hr />

		<h3>常见问题</h3>

		<h4>MongoDB - error:13 Permission deny</h4>
		<p>安装好 MongoDB 后，使用命令 <code>mongod</code> 启动 Mongo 时，可能会遇到 permission deny 的问题：</p>
		<pre><code>exception in initAndListen: 10309 Unable to create/open lock file: /data/db/mongod.lock errno:13 Permission denied Is a mongod instance already running?, terminating</code></pre>

		<p>这是因为当前的用户没有权限访问 <code>/data/db</code> 目录</p>
<pre><code># To fix it
chown &lt;username&gt; /data/db</code></pre>

		<h4>-bash: node: command not found</h4>
		<p>如果出现 <code>-bash: node: command not found</code> 错误，先检查 node 是否已经真的安装了：</p>
<pre><code>s -l /usr/local/bin | grep node
# Bash display below message is mean that node have existed
>> -rwxrwxr-x 1 root root 11515348 10月  1 03:48 node
>> lrwxrwxrwx 1 root root       38 10月  1 03:52 npm -> ../lib/node_modules/npm/bin/npm-cli.js
ls -l /usr/local/bin/node
# Bash desplay below message
>> -rwxrwxr-x 1 root root 11515348 10月  1 03:48 /usr/local/bin/node</code></pre>

		<p>如果出现上面的结果，那么 node 已经安装了，那么可能就是编译路径未配置，配置编译路径，在 <code>/etc/profile</code> 文件里面，添加两行：</p>

<pre><code>export PATH="$HOME/local/node/bin:$PATH"
export NODE_PATH="$HOME/local/node:$HOME/local/node/lib/node_modules"</code></pre>

		<p>然后重启系统：</p>
		<pre><code>reboot -f</code></pre>

		<h4>-bash: npm: command not found</h4>
		<p>安装好 Node 后，可以使用 npm 来安装 AngularJS 和 Express，但使用 npm 的时候，可能会出现错误：<code>-bash: npm: command not found</code></p>

		<p>在 terminal 里面输入以下命令解决：</p>
<pre><code>sudo ln -s /usr/local/bin/node /usr/bin/node
sudo ln -s /usr/local/lib/node /usr/lib/node
sudo ln -s /usr/local/bin/npm /usr/bin/npm
sudo ln -s /usr/local/bin/node-waf /usr/bin/node-waf</code></pre>

		<h4>如何开放 AWS EC2 Instance 的 80 端口</h4>
		<ol>
			<li>Go to the Security Group settings in the left hand navigation</li>
			<li>Find the Security Group that your instance is apart of</li>
			<li>Click on Inbound Rules</li>
			<li>Use the drop down and add HTTP (port 80)</li>
			<li>Click Apply and enjoy</li>
		</ol>

		<p>2014-12-20</p>

	</section>
</div>

<!-- Footer Start -->
<div id="footer_wrap" class="outer">
	<footer class="inner">
		<p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
	</footer>
</div>
<!-- Footer End -->

<script type="text/javascript">
	var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
	document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>

<script type="text/javascript">
	try {
		var pageTracker = _gat._getTracker("UA-31471277-1");
		pageTracker._trackPageview();
	} catch(err) {}
</script>

</body>
</html>